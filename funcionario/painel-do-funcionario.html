<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel do Funcion√°rio ‚Äî Belo Vidro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .modal {
        display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
        justify-content: center;
        align-items: center;
    }
    .modal-content {
        background-color: #1f2937; /* Cor de fundo escura */
        color: white; /* Cor do texto */
        padding: 24px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        width: 90%;
        max-width: 600px;
    }
    .notification-bell-container {
        position: relative;
    }
    .notification-dot {
        position: absolute;
        top: -2px;
        right: -2px;
        height: 10px;
        width: 10px;
        background-color: #ef4444; /* red-500 */
        border-radius: 50%;
        display: none; /* Inicia oculto */
    }
  </style>
</head>
<body class="bg-slate-900 text-white min-h-screen flex">
  <aside class="w-72 bg-white text-slate-800 p-6 shadow-2xl flex flex-col gap-6">

    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 bg-emerald-600 rounded-md"></div>
        <div class="font-bold text-lg">Belo Vidro</div>
      </div>
      <button onclick="logout()" class="text-xs text-slate-500 hover:text-red-600 font-medium transition-colors">
        Sair
      </button>
    </div>

    <div class="space-y-2">
      <div class="text-xs uppercase tracking-wider text-slate-500">Acesso</div>
      <div class="text-sm font-medium">Usu√°rio: <span id="nome-usuario-sidebar" class="text-emerald-600"></span></div>
    </div>
    <a href="tarefasf.html">
        <button class="w-full bg-slate-300 hover:bg-slate-200 text-slate-800 py-2 rounded-lg transition">
            üìã Minhas Tarefas
        </button>
      </a>
    <a id="btnMinhaRota" href="painel de rotas.html" class=" flex items-center justify-center bg-slate-200 hover:bg-slate-300 text-slate-800 py-2 px-4 rounded-lg transition font-medium"> üó∫Ô∏è Minha Rota</a>
      <div class="mt-auto">
                <button onclick="logout()" class=" w-full flex items-center justify-center bg-green-800 hover:bg-slate-300 text-slate-800 py-2 px-4 rounded-lg transition font-medium">
                    Sair
                </button>
            </div> 

    <div class="mt-auto text-xs text-slate-500">v0.1 ‚Ä¢ Realtime DB</div>
  </aside>

  <script>
    function logout() {
      localStorage.removeItem("bv.session");
      window.location.replace("https://belovidro.github.io/belo-vidro-app-interno");
    }
    
    // A fun√ß√£o de prote√ß√£o precisa ser definida globalmente para ser chamada
    (function protect(requiredRoles = ["funcionario", "funcionariorota", "sistema", "vendedor"]) {
      try {
        const s = JSON.parse(localStorage.getItem("bv.session") || "null");
        if (!s || !requiredRoles.includes(s.role)) location.replace("https://belovidro.github.io/belo-vidro-app-interno/");
      } catch(e){ location.replace("https://belovidro.github.io/belo-vidro-app-interno/"); }
    })();
  </script>

  <main class="flex-1 p-6">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold">Meu Painel</h1>
      <div class="flex items-center gap-3">
        <span id="nome-usuario-header" class="text-sm text-slate-300"></span>
        <div class="notification-bell-container">
            <button onclick="toggleModal('notificationModal')" class="relative text-white hover:text-green-500 focus:outline-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405C18.21 14.73 18 13.918 18 13V6a6 6 0 00-12 0v7c0 .918-.21 1.73-.595 2.595L4 17h5m6 0v1a3 3 0 01-6 0v-1m6 0H9" />
                </svg>
                <span id="notificationDot" class="notification-dot"></span>
            </button>
        </div>
        <div class="h-10 w-10 rounded-full bg-slate-700"></div>
      </div>
    </header>

    <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="bg-slate-800 rounded-xl p-5 shadow">
        <div class="text-slate-400">Sal√°rio Base</div>
        <div id="salarioBase" class="text-3xl font-semibold mt-2">R$ 5.000,00</div>
      </div>
      <div class="bg-slate-800 rounded-xl p-5 shadow">
        <div class="text-slate-400">Total de Horas Aprovadas</div>
        <div id="totalHorasAprov" class="text-3xl font-semibold mt-2">0 h</div>
      </div>
      <div class="bg-slate-800 rounded-xl p-5 shadow">
        <div class="text-slate-400">Total Recebido (Horas Extras)</div>
        <div id="totalRecebido" class="text-3xl font-semibold mt-2">R$ 0,00</div>
      </div>
    </section>

    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">

      <div class="bg-slate-800 rounded-xl p-5 shadow">
        <h2 class="text-xl font-semibold mb-4">Solicitar Horas Extras</h2>
        <form id="formSolicitacao" class="space-y-3">
          <div>
            <label class="block text-sm text-slate-300 mb-1">Data</label>
            <input id="inpData" type="date" required
                   class="w-full rounded-lg bg-slate-900 border border-slate-700 px-3 py-2 outline-none focus:border-indigo-500">
          </div>
          <div>
            <label class="block text-sm text-slate-300 mb-1">Horas solicitadas</label>
            <input id="inpHoras" type="number" min="1" step="1" required
                   class="w-full rounded-lg bg-slate-900 border border-slate-700 px-3 py-2 outline-none focus:border-indigo-500">
          </div>
          <div>
            <label class="block text-sm text-slate-300 mb-1">Observa√ß√£o</label>
            <textarea id="inpObs" rows="3" placeholder="Ex.: plant√£o, entrega..."
                      class="w-full rounded-lg bg-slate-900 border border-slate-700 px-3 py-2 outline-none focus:border-indigo-500"></textarea>
          </div>
          <button class="w-full bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg py-2 font-medium transition">
            Enviar Solicita√ß√£o
          </button>
          <p class="text-xs text-slate-400">
            * A solicita√ß√£o ser√° gravada em <code>horas-extras/REGISTROX</code> com status <b>pendente</b>.
          </p>
        </form>
      </div>
      
      <div class="space-y-6">
        <div class="bg-slate-800 rounded-xl p-5 shadow">
          <h2 class="text-xl font-semibold mb-4">Minhas Horas (todas)</h2>
          <ul id="listaHoras" class="space-y-2 text-sm"></ul>
        </div>
        <div class="bg-slate-800 rounded-xl p-5 shadow">
          <h2 class="text-xl font-semibold mb-4">Valores j√° recebidos</h2>
          <ul id="listaValores" class="space-y-2 text-sm"></ul>
        </div>
      </div>
    </section>

  </main>

  <div id="notificationModal" class="modal">
    <div class="modal-content">
        <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-4">
            <h3 class="text-2xl font-bold">üì© Lembretes e Notifica√ß√µes</h3>
            <button onclick="toggleModal('notificationModal')" class="text-gray-400 hover:text-gray-200 text-3xl">&times;</button>
        </div>

        <div id="receivedRemindersContainer" class="space-y-4">
            <div class="text-gray-500">Nenhum lembrete recebido.</div>
        </div>
        
        <div class="mt-6 text-center">
            <button onclick="openSendReminderModal()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg py-2 font-medium transition">
                Criar novo Lembrete
            </button>
        </div>
    </div>
  </div>

  <div id="sendReminderModal" class="modal">
    <div class="modal-content">
        <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-4">
            <h3 class="text-2xl font-bold">‚úçÔ∏è Enviar Lembrete</h3>
            <button onclick="toggleModal('sendReminderModal')" class="text-gray-400 hover:text-gray-200 text-3xl">&times;</button>
        </div>
        <form id="formLembrete" class="space-y-3">
            <div>
                <label class="block text-sm text-slate-300 mb-1">Destinat√°rio</label>
                <input id="inpDestinatario" type="text" required
                       class="w-full rounded-lg bg-slate-900 border border-slate-700 px-3 py-2 outline-none focus:border-indigo-500">
            </div>
            <div>
                <label class="block text-sm text-slate-300 mb-1">Mensagem</label>
                <textarea id="inpMensagem" rows="3" required
                          class="w-full rounded-lg bg-slate-900 border border-slate-700 px-3 py-2 outline-none focus:border-indigo-500"></textarea>
            </div>
            <button class="w-full bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg py-2 font-medium transition">
                Enviar Lembrete
            </button>
        </form>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getDatabase, ref, onValue, get, set, update, push } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

    // O c√≥digo de prote√ß√£o deve ser o primeiro a rodar
    (function protect(requiredRoles = ["funcionario", "funcionariorota", "sistema", "vendedor"]) {
      try {
          const s = JSON.parse(localStorage.getItem("bv.session") || "null");
          if (!s || !requiredRoles.includes(s.role)) location.replace("/logns/logns.html");
      } catch(e){ location.replace("/logns/logns.html"); }
    })();
    
    // === Config do seu projeto (inclui databaseURL para Realtime DB) ===
    const firebaseConfig = {
      apiKey: "AIzaSyDQGXH3b2bMR7ZdKPZm-vPONKijkRw-Xgg",
      authDomain: "belo-vidro-banco-de-dados.firebaseapp.com",
      projectId: "belo-vidro-banco-de-dados",
      storageBucket: "belo-vidro-banco-de-dados.firebasestorage.app",
      messagingSenderId: "705873952615",
      appId: "1:705873952615:web:83613fd5d2839aad66b9c2",
      databaseURL: "https://belo-vidro-banco-de-dados-default-rtdb.firebaseio.com"
    };

    // ==== Inicializa√ß√£o ====
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // === ADICIONADO: PEGA O NOME DO USU√ÅRIO DA SESS√ÉO ===
    const sessao = JSON.parse(localStorage.getItem("bv.session") || "null");
    const NOME_FUNC = sessao?.name || "Funcion√°rio";
    
    // === Controle de exibi√ß√£o do bot√£o "Minha Rota" ===
    const btnRota = document.getElementById("btnMinhaRota");
    if (sessao?.role !== "funcionariorota") {
      btnRota.style.display = "none";
    }
    
    // Refer√™ncias HTML para os modais e formul√°rios
    const notificationModal = document.getElementById('notificationModal');
    const sendReminderModal = document.getElementById('sendReminderModal');
    const receivedRemindersContainer = document.getElementById('receivedRemindersContainer');
    const notificationDot = document.getElementById('notificationDot');
    
    const formLembrete = document.getElementById('formLembrete');
    const inpDestinatario = document.getElementById('inpDestinatario');
    const inpMensagem = document.getElementById('inpMensagem');

    // === Fun√ß√µes dos Modais e Lembretes ===
    window.toggleModal = (modalId) => {
        const modal = document.getElementById(modalId);
        modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
        if (modalId === 'notificationModal' && modal.style.display === 'flex') {
            checkAndRenderReminders();
        }
    };

    window.openSendReminderModal = () => {
        toggleModal('notificationModal');
        toggleModal('sendReminderModal');
    };

    window.markAsRead = (reminderId) => {
        update(ref(db, `lembrete/${reminderId}`), {lido: "sim"})
            .then(() => console.log("Lembrete marcado como lido"))
            .catch(error => console.error("Erro ao marcar como lido:", error));
    };

    function checkAndRenderReminders() {
      const lembreteRef = ref(db, 'lembrete');
      onValue(lembreteRef, (snapshot) => {
        const notifications = snapshot.val() || {};
        const remindersForMe = Object.entries(notifications).filter(([id, notif]) => {
          return notif.destinatario?.toLowerCase() === NOME_FUNC.toLowerCase() && notif.lido === "n√£o";
        });

        receivedRemindersContainer.innerHTML = '';
        if (remindersForMe.length === 0) {
          receivedRemindersContainer.innerHTML = '<div class="text-gray-500">Nenhum lembrete recebido.</div>';
          notificationDot.style.display = 'none';
        } else {
          remindersForMe.forEach(([id, notif]) => {
            const reminderCard = document.createElement('div');
            reminderCard.className = `p-4 rounded-lg border bg-slate-700 text-white border-green-500`;
            reminderCard.innerHTML = `
              <p><strong>De:</strong> ${notif.remetente}</p>
              <p class="mt-1">${notif.mensagem}</p>
              <p class="text-xs mt-2 text-gray-400">${new Date(notif.timestamp).toLocaleString()}</p>
              <button onclick="markAsRead('${id}')" class="mt-2 text-green-400 hover:text-green-500">Marcar como lido</button>
            `;
            receivedRemindersContainer.prepend(reminderCard);
          });
          notificationDot.style.display = 'block';
        }
      });
    }

    // Fun√ß√£o para enviar um novo lembrete
    async function sendReminder(destinatario, mensagem) {
      if (!destinatario || !mensagem) {
        alert("Por favor, preencha o destinat√°rio e a mensagem.");
        return;
      }

      const newReminder = {
        remetente: NOME_FUNC,
        destinatario: destinatario.trim(),
        mensagem: mensagem.trim(),
        timestamp: new Date().toISOString(),
        lido: "n√£o"
      };

      try {
        await push(ref(db, "lembrete"), newReminder);
        alert("Lembrete enviado com sucesso!");
        formLembrete.reset();
        toggleModal('sendReminderModal');
      } catch (error) {
        console.error("Erro ao enviar o lembrete:", error);
        alert("Ocorreu um erro ao enviar o lembrete.");
      }
    }
    

    // ATUALIZA OS ELEMENTOS NO HTML COM O NOME
    document.getElementById("nome-usuario-sidebar").textContent = NOME_FUNC;
    document.getElementById("nome-usuario-header").textContent = NOME_FUNC;

    // ==== Constantes do painel ====
    const VALOR_HORA_EXTRA = 25; // usado s√≥ se o registro n√£o tiver campo "valorpago"
    const fmtBRL = new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" });

    // ==== Helpers ====
    function toBRDateStrFromInput(value) {
      if (!value) return "";
      const [y, m, d] = value.split("-");
      return `${d}/${m}/${y}`;
    }

    function normalizaNome(s) {
      return (s || "").toString().trim().toLowerCase();
    }

    // ==== Carregar e exibir dados do n√≥ horas-extras ====
    const raizHorasRef = ref(db, "horas-extras");

    function renderizarListas() {
      onValue(raizHorasRef, (snap) => {
        const dados = snap.val() || {};
        const itens = Object.entries(dados).map(([id, r]) => ({ id, ...r }));

        // Filtra APENAS do usu√°rio logado (case-insensitive)
        const meus = itens.filter(i => normalizaNome(i.funcionario) === normalizaNome(NOME_FUNC));

        // Preenche "Minhas Horas"
        const ulHoras = document.getElementById("listaHoras");
        ulHoras.innerHTML = "";
        if (meus.length === 0) {
          ulHoras.innerHTML = `<li class="text-slate-400">Nenhum registro.</li>`;
        } else {
          meus
            .sort((a, b) => a.data?.localeCompare?.(b.data ?? "") ?? 0)
            .forEach(i => {
              const li = document.createElement("li");
              li.className = "bg-slate-900/60 border border-slate-700 rounded-lg p-2";
              li.textContent = `${i.data ?? "-"} ‚Ä¢ ${i.horas ?? 0}h ‚Ä¢ ${i.status ?? "pendente"} ‚Ä¢ ${i.observacao ?? "-"}`;
              ulHoras.appendChild(li);
            });
        }

        // Valores recebidos (apenas aprovados e pagos)
        let totalHorasAprov = 0;
        let totalRecebido = 0;
        const ulValores = document.getElementById("listaValores");
        ulValores.innerHTML = "";

        // L√ìGICA ATUALIZADA: agora filtra por status 'aprovado' e 'pago'
        const aprovados = meus.filter(i => ["aprovado", "pago"].includes((i.status || "").toLowerCase()));
        
        if (aprovados.length === 0) {
          ulValores.innerHTML = `<li class="text-slate-400">Nenhum pagamento de horas extras aprovado.</li>`;
        } else {
          aprovados.forEach(i => {
            const horas = Number(i.horas || 0);
            
            // L√ìGICA CORRIGIDA: usa o 'valorpago' ou 0 se n√£o estiver definido
            const valor = (i.valorpago !== undefined && i.valorpago !== null)
              ? Number(i.valorpago)
              : 0;

            totalHorasAprov += horas;
            totalRecebido += valor;

            const li = document.createElement("li");
            li.className = "bg-slate-900/60 border border-slate-700 rounded-lg p-2 flex justify-between";
            li.innerHTML = `
              <span>${i.data ?? "-"} ‚Ä¢ ${horas}h ${i.valorpago == null ? "(n√£o pago)" : ""}</span>
              <span class="font-semibold">${fmtBRL.format(valor)}</span>
            `;
            ulValores.appendChild(li);
          });
        }

        // Atualiza cards
        document.getElementById("totalHorasAprov").textContent = `${totalHorasAprov} h`;
        document.getElementById("totalRecebido").textContent = fmtBRL.format(totalRecebido);
      }, (err) => {
        console.error("Erro ao ler horas-extras:", err);
      });
    }

    // ==== Criar registro seguindo o padr√£o REGISTROX em horas-extras ====
    async function criarRegistroHorasExtras(registro) {
      const snap = await get(raizHorasRef);
      let proximoNumero = 1;

      if (snap.exists()) {
        const chaves = Object.keys(snap.val());
        const nums = chaves
          .map(k => (k.match(/^REGISTRO(\d+)$/i)?.[1]))
          .filter(Boolean)
          .map(n => parseInt(n, 10))
          .filter(n => !Number.isNaN(n));
        if (nums.length > 0) {
          proximoNumero = Math.max(...nums) + 1;
        }
      }

      const novaChave = `REGISTRO${proximoNumero}`;
      await set(ref(db, `horas-extras/${novaChave}`), registro);
      return novaChave;
    }

    // ==== Formul√°rio: enviar solicita√ß√£o ====
    const form = document.getElementById("formSolicitacao");
    const inpData = document.getElementById("inpData");
    const inpHoras = document.getElementById("inpHoras");
    const inpObs = document.getElementById("inpObs");

    // Preenche data de hoje no input
    (function setHoje() {
      const hoje = new Date();
      const yyyy = hoje.getFullYear();
      const mm = String(hoje.getMonth() + 1).padStart(2, "0");
      const dd = String(hoje.getDate()).padStart(2, "0");
      inpData.value = `${yyyy}-${mm}-${dd}`;
    })();

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const horas = Number(inpHoras.value);
      if (!Number.isFinite(horas) || horas <= 0) {
        alert("Informe um n√∫mero de horas v√°lido.");
        return;
      }

      const registro = {
        data: toBRDateStrFromInput(inpData.value),
        funcionario: NOME_FUNC, // USANDO O NOME DA VARI√ÅVEL DIN√ÇMICA
        horas: horas,
        observacao: inpObs.value?.trim() || "",
        status: "pendente"
      };

      try {
        const chave = await criarRegistroHorasExtras(registro);
        alert(`Solicita√ß√£o enviada! (${chave})`);
        form.reset();
        (function setHojeAgain() {
          const hoje = new Date();
          const yyyy = hoje.getFullYear();
          const mm = String(hoje.getMonth() + 1).padStart(2, "0");
          const dd = String(hoje.getDate()).padStart(2, "0");
          inpData.value = `${yyyy}-${mm}-${dd}`;
        })();
      } catch (err) {
        console.error("Falha ao criar registro:", err);
        alert("Ocorreu um erro ao enviar a solicita√ß√£o. Veja o console.");
      }
    });

    // Evento de envio para o novo formul√°rio de lembrete
    formLembrete.addEventListener("submit", (e) => {
        e.preventDefault();
        sendReminder(inpDestinatario.value, inpMensagem.value);
    });

    // ==== Start ====
    renderizarListas();
    checkAndRenderReminders();
  </script>
</body>
</html>








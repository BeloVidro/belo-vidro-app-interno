<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Painel do Chefe ‚Äî Horas Extras</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 600px;
        }
        .notification-bell-container {
            position: relative;
        }
        .notification-dot {
            position: absolute;
            top: 0px;
            right: 0px;
            height: 10px;
            width: 10px;
            background-color: red;
            border-radius: 50%;
            display: none; /* Inicia oculto */
        }
    </style>
    <script>
        (function protect(requiredRoles=["admin"]) {
            try {
                const s = JSON.parse(localStorage.getItem("bv.session")||"null");
                if (!s || !requiredRoles.includes(s.role)) location.replace("index.html");
            } catch(e){ location.replace("index.html"); }
        })(["admin"]);
    </script>
</head>
<body class="bg-gray-100 flex h-screen">

    <script>
        function logout() {
            localStorage.removeItem("bv.session");
            window.location.replace("index.html");
        }
    </script>

    <aside class="w-64 bg-white shadow-md p-4">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold">Controle do Chefe</h2>
            <div class="notification-bell-container">
                <button onclick="toggleModal('notificationModal')" class="relative text-gray-800 hover:text-orange-600 focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405C18.21 14.73 18 13.918 18 13V6a6 6 0 00-12 0v7c0 .918-.21 1.73-.595 2.595L4 17h5m6 0v1a3 3 0 01-6 0v-1m6 0H9" />
                    </svg>
                    <span id="notificationDot" class="notification-dot"></span>
                </button>
            </div>
        </div>
        <nav class="space-y-3">
            <a href="adm/relatorio-gastos.html">
            <button class="w-full flex items-center p-3 bg-green-100 rounded-lg">üìã Relatorio de Gastos</button></a>
            <a href="adm/desempelho.html"><button class="w-full flex items-center p-3 bg-orange-100 rounded-lg">‚≠ê Desempelho</button>
            </a>
            <a href="adm/TAREFAS.html"><button class="w-full flex items-center p-3 bg-red-100 rounded-lg">üìÖ Tarefas</button></a>
            <a href="adm/ROTAS.html"><button class="w-full flex items-center p-3 bg-blue-100 rounded-lg">üó∫Ô∏è Rotas</button></a>
            <a href="adm/painel-adm.html"><button id="btnExtraHours" class="w-full flex items-center p-3 bg-purple-100 rounded-lg">‚è± Extra Hours</button></a>
            <div class="mt-auto">
                <button onclick="logout()" class=" w-full flex items-center justify-center bg-green-800 hover:bg-slate-300 text-slate-800 py-2 px-4 rounded-lg transition font-medium">
                    Sair
                </button>
            </div> 
        </nav>
    </aside>

    <main class="flex-1 p-6">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold">Dashboard</h1>
            <div class="flex items-center space-x-4">
                <button id="btnAdicionarHoras" class="px-4 py-2 bg-green-700 text-white rounded-lg hover:bg-gray-700 transition duration-300">
                    ‚ûï Adicionar Horas
                </button>
                <button id="btnAbrirPendentes" class="relative text-gray-600 hover:text-purple-600" title="Horas pendentes de aprova√ß√£o">
                    üìã
                    <span id="badgePendentes" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs px-2 rounded-full hidden">0</span>
                </button>
                <span class="text-gray-600">Chefe</span>
                <img src="https://via.placeholder.com/40" class="rounded-full" alt="User" />
            </div>
        </header>

        <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-4 rounded-lg shadow text-center">
                <h3 class="text-gray-500">Gastos Extras</h3>
                <p class="text-xl font-bold text-blue-600">R$ 0,00</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow text-center">
                <h3 class="text-gray-500">Custo/Hora</h3>
                <p class="text-xl font-bold text-green-600">R$ 0,00</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow text-center">
                <h3 class="text-gray-500">Funcion√°rios</h3>
                <p class="text-xl font-bold text-orange-600">0</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow text-center">
                <h3 class="text-gray-500">Horas Extras</h3>
                <p id="totalHoras" class="text-xl font-bold text-purple-600">0h</p>
            </div>
        </div>

        <div class="flex flex-col sm:flex-row justify-between items-center mb-3 space-y-2 sm:space-y-0 sm:space-x-4">
            <h2 class="text-xl font-bold">Gerenciar Horas Extras</h2>
            <div class="flex items-center space-x-2 w-full sm:w-auto">
                <input
                    type="text"
                    id="filtroFuncionario"
                    placeholder="Buscar funcion√°rio..."
                    class="p-2 border rounded w-full"
                    onkeyup="filtrarTabela()"
                />
                <input
                    type="date"
                    id="filtroData"
                    class="p-2 border rounded w-full"
                    onchange="filtrarTabela()"
                />
            </div>
        </div>

        <section id="extraHours">
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="overflow-x-auto">
                    <table class="w-full text-left min-w-[640px]">
                        <thead>
                            <tr class="border-b">
                                <th class="p-1">Funcion√°rio</th>
                                <th class="p-3">Data</th>
                                <th class="p-3">Horas</th>
                                <th class="p-3">Observa√ß√£o</th>
                                <th class="p-3">Status</th>
                                <th class="p-3">ValorPago</th>
                                <th class="p-8">A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="tabela">
                            <tr><td colspan="7" class="text-center p-1">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-96 shadow-lg">
            <div class="flex items-start justify-between mb-3">
                <h3 class="text-lg font-bold">Aprovar Hora Extra</h3>
                <button onclick="fecharModal()" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            <div class="space-y-1 text-sm">
                <p><b>Funcion√°rio:</b> <span id="modalFuncionario"></span></p>
                <p><b>Data:</b> <span id="modalData"></span></p>
                <p><b>Horas:</b> <span id="modalHoras"></span></p>
                <p><b>Obs.:</b> <span id="modalObs"></span></p>
            </div>
            <label class="block mt-4 text-sm">
                <span class="text-gray-700">Motivo (opcional)</span>
                <input id="modalMotivo" class="w-full border rounded p-2 mt-1" placeholder="Ex.: plant√£o, entrega, etc." />
                <span class="text-gray-700">Valor Pago (R$)</span>
                <input type="number" id="modalValorPago" class="w-full border rounded p-2 mt-1" placeholder="Ex.: 50.00" step="0.01" />
            </label>
            <div class="mt-5 flex justify-end gap-2">
                <button onclick="fecharModal()" class="px-4 py-2 bg-gray-200 rounded">Fechar</button>
                <button id="btnNegar" class="px-4 py-2 bg-red-500 text-white rounded">Negar</button>
                <button id="btnAprovar" class="px-4 py-2 bg-green-600 text-white rounded">Aprovar</button>
                <button id="btnPagar" class="px-4 py-2 bg-blue-500 text-white rounded">Pagar</button>
            </div>
        </div>
    </div>

    <div id="modalPendentes" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-[28rem] shadow-lg">
            <div class="flex items-start justify-between mb-3">
                <h3 class="text-lg font-bold">Horas pendentes de aprova√ß√£o</h3>
                <button onclick="fecharPendentes()" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            <ul id="listaPendentes" class="space-y-2 max-h-72 overflow-y-auto text-sm">
            </ul>
            <div class="mt-4 text-right">
                <button onclick="fecharPendentes()" class="px-4 py-2 bg-gray-200 rounded">Fechar</button>
            </div>
        </div>
    </div>

    <div id="modalAdicionar" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-96 shadow-lg">
            <div class="flex items-start justify-between mb-3">
                <h3 class="text-lg font-bold">Adicionar Nova Hora Extra</h3>
                <button onclick="fecharModalAdicionar()" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            <form id="formAdicionarHoras" class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-700">Funcion√°rio</label>
                    <input type="text" id="addFuncionario" class="w-full border rounded p-2 mt-1" required />
                </div>
                <div>
                    <label class="block text-sm text-gray-700">Data</label>
                    <input type="date" id="addData" class="w-full border rounded p-2 mt-1" required />
                </div>
                <div>
                    <label class="block text-sm text-gray-700">Horas</label>
                    <input type="number" id="addHoras" class="w-full border rounded p-2 mt-1" required min="1" />
                </div>
                <div>
                    <label class="block text-sm text-gray-700">Observa√ß√£o</label>
                    <input type="text" id="addObs" class="w-full border rounded p-2 mt-1" />
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="fecharModalAdicionar()" class="px-4 py-2 bg-gray-200 rounded">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="notificationModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Lembretes e Notifica√ß√µes</h2>
            <div class="flex justify-end">
                <button onclick="toggleModal('notificationModal')" class="text-gray-500 hover:text-gray-800">Fechar</button>
            </div>
            
            <div class="mb-6">
                <h3 class="font-semibold text-lg mb-2">Enviar um Lembrete</h3>
                <div class="flex flex-col space-y-2">
                    <label for="recipientSelect" class="text-sm text-gray-600">Para:</label>
                    <select id="recipientSelect" class="p-2 border rounded-lg w-full"></select>
                    <label for="reminderDescription" class="text-sm text-gray-600">Mensagem:</label>
                    <textarea id="reminderDescription" class="p-2 border rounded-lg w-full" rows="3"></textarea>
                    <button onclick="sendReminder()" class="p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Enviar Lembrete</button>
                </div>
            </div>

            <div>
                <h3 class="font-semibold text-lg mb-2">Lembretes Recebidos</h3>
                <div id="receivedRemindersContainer" class="space-y-4">
                    <div class="text-gray-500">Nenhum lembrete recebido.</div>
                </div>
            </div>

        </div>
    </div>
    
<script type="module">
    // Firebase SDK (Realtime Database)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getDatabase, ref, onValue, update, push, set } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

    const sessao = JSON.parse(localStorage.getItem("bv.session") || "null");

    // >>> SUA CONFIG (j√° do seu projeto)
    const firebaseConfig = {
        apiKey: "AIzaSyDQGXH3b2bMR7ZdKPZm-vPONKijkRw-Xgg",
        authDomain: "belo-vidro-banco-de-dados.firebaseapp.com",
        projectId: "belo-vidro-banco-de-dados",
        storageBucket: "belo-vidro-banco-de-dados.firebasestorage.app",
        messagingSenderId: "705873952615",
        appId: "1:705873952615:web:83613fd5d2839aad66b9c2",
        databaseURL: "https://belo-vidro-banco-de-dados-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Refer√™ncias HTML para o sino
    const notificationModal = document.getElementById('notificationModal');
    const receivedRemindersContainer = document.getElementById('receivedRemindersContainer');
    const recipientSelect = document.getElementById('recipientSelect');
    const reminderDescription = document.getElementById('reminderDescription');
    const notificationDot = document.getElementById('notificationDot');
    
    // Estado atual
    let registroAtualId = null;
    let cacheLinhas = [];
    let allUsers = {};
    
    // Cache para os dados do dashboard
    let dadosHoras = null;
    let dadosFuncionarios = null;
    let dadosGastos = null;

    // Fun√ß√µes do Modal de Notifica√ß√µes
    window.toggleModal = (modalId) => {
        const modal = document.getElementById(modalId);
        modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
        if (modal.style.display === 'flex') {
            checkAndRenderReminders();
        }
    };

    window.sendReminder = () => {
        const recipient = recipientSelect.value;
        const message = reminderDescription.value;
        if (!recipient || !message) {
            alert("Por favor, selecione um destinat√°rio e escreva uma mensagem.");
            return;
        }
        const newReminderRef = push(ref(db, 'lembrete'));
        set(newReminderRef, {
            remetente: "Chefe", // Remetente fixo como "Chefe"
            destinatario: recipient,
            mensagem: message,
            lido: "n√£o", // Valor fixo para o status lido
            timestamp: Date.now()
        }).then(() => {
            alert("Lembrete enviado!");
            reminderDescription.value = "";
            toggleModal('notificationModal');
        }).catch(error => {
            console.error("Erro ao enviar lembrete:", error);
            alert("Erro ao enviar lembrete. Tente novamente.");
        });
    };

    window.markAsRead = (reminderId) => {
        set(ref(db, `lembrete/${reminderId}/lido`), "sim")
            .then(() => console.log("Lembrete marcado como lido"))
            .catch(error => console.error("Erro ao marcar como lido:", error));
    };

    function checkAndRenderReminders() {
        onValue(ref(db, 'lembrete'), (snapshot) => {
            const notifications = snapshot.val() || {};
            const remindersForMe = Object.entries(notifications).filter(([id, notif]) => notif.destinatario === "Chefe"); // Filtra para o chefe
            
            receivedRemindersContainer.innerHTML = '';
            if (remindersForMe.length === 0) {
                receivedRemindersContainer.innerHTML = '<div class="text-gray-500">Nenhum lembrete recebido.</div>';
                notificationDot.style.display = 'none';
            } else {
                let hasUnread = false;
                remindersForMe.forEach(([id, notif]) => {
                    if (notif.lido === "n√£o") {
                        hasUnread = true;
                    }
                    const reminderCard = document.createElement('div');
                    reminderCard.className = `p-4 rounded-lg border ${notif.lido === "sim" ? 'bg-gray-100 text-gray-600' : 'bg-white text-gray-800 border-orange-500'}`;
                    reminderCard.innerHTML = `
                        <p><strong>De:</strong> ${notif.remetente}</p>
                        <p>${notif.mensagem}</p>
                        <p class="text-xs mt-2 text-gray-400">${new Date(notif.timestamp).toLocaleString()}</p>
                        ${notif.lido === "n√£o" ? `<button onclick="markAsRead('${id}')" class="mt-2 text-blue-500 hover:text-blue-700">Marcar como lido</button>` : ''}
                    `;
                    receivedRemindersContainer.prepend(reminderCard);
                });
                notificationDot.style.display = hasUnread ? 'block' : 'none';
            }
        });
    }
    
    // --- FUN√á√ïES J√Å EXISTENTES DO PAINEL ---
    window.fecharModal = () => {
        const m = document.getElementById("modal");
        m.classList.add("hidden");
        m.classList.remove("flex");
        registroAtualId = null;
        document.getElementById("modalMotivo").value = "";
    };
    window.abrirPendentes = () => {
        const m = document.getElementById("modalPendentes");
        m.classList.remove("hidden");
        m.classList.add("flex");
    };
    window.fecharPendentes = () => {
        const m = document.getElementById("modalPendentes");
        m.classList.add("hidden");
        m.classList.remove("flex");
    };
    window.abrirModalAdicionar = () => {
        const m = document.getElementById("modalAdicionar");
        m.classList.remove("hidden");
        m.classList.add("flex");
    };
    window.fecharModalAdicionar = () => {
        const m = document.getElementById("modalAdicionar");
        m.classList.add("hidden");
        m.classList.remove("flex");
        document.getElementById("formAdicionarHoras").reset();
    };
    
    function formatarDataParaYYYYMMDD(dataDDMMYYYY) {
        if (!dataDDMMYYYY) return null;
        const [dia, mes, ano] = dataDDMMYYYY.split('/');
        return `${ano}-${mes}-${dia}`;
    }

    window.filtrarTabela = () => {
        const filtroFuncionario = document.getElementById("filtroFuncionario").value.toLowerCase();
        const filtroData = document.getElementById("filtroData").value;
        const linhas = document.querySelectorAll("#tabela tr[data-row='true']");
        
        linhas.forEach(tr => {
            const nome = (tr.getAttribute("data-funcionario") || "").toLowerCase();
            const dataDDMMYYYY = tr.getAttribute("data-data");
            const dataYYYYMMDD = formatarDataParaYYYYMMDD(dataDDMMYYYY);
            
            const mostraPorFuncionario = nome.includes(filtroFuncionario);
            const mostraPorData = !filtroData || dataYYYYMMDD === filtroData;
            
            tr.style.display = (mostraPorFuncionario && mostraPorData) ? "" : "none";
        });
    };

    function carregarTabelaHoras(dados) {
        const tbody = document.getElementById("tabela");
        tbody.innerHTML = "";
        cacheLinhas = [];
        let cachePendentes = [];

        if (dados) {
            Object.entries(dados).forEach(([id, linha]) => {
                const funcionario = linha.funcionario ?? "-";
                const data = linha.data ?? "-";
                const horas = parseInt(linha.horas ?? 0, 10) || 0;
                const obs = linha.observacao ?? "-";
                const status = linha.status ?? "pendente";
                const valorpago = linha.valorpago || 0;
                const valorFormatado = valorpago.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                
                cacheLinhas.push({ id, funcionario, data, horas, obs, status, valorFormatado });

                const tr = document.createElement("tr");
                tr.className = "border-b";
                tr.setAttribute("data-row", "true");
                tr.setAttribute("data-funcionario", funcionario);
                tr.setAttribute("data-data", data);
                
                tr.innerHTML = `
                    <td class="p-2">${funcionario}</td>
                    <td class="p-2">${data}</td>
                    <td class="p-2">${horas}</td>
                    <td class="p-2">${obs}</td>
                    <td class="p-2">${status}</td>
                    <td class="p-2">${valorFormatado}</td>
                    <td class="p-2">
                        <button class="btn-acao text-blue-600 underline" data-id="${id}">A√ß√£o</button>
                    </td>
                `;
                tbody.appendChild(tr);

                if (status === "pendente") {
                    cachePendentes.push({ id, funcionario, data, horas, obs, status });
                }
            });
            
            const badge = document.getElementById("badgePendentes");
            if (cachePendentes.length > 0) {
                badge.textContent = cachePendentes.length;
                badge.classList.remove("hidden");
            } else {
                badge.classList.add("hidden");
            }

            const ul = document.getElementById("listaPendentes");
            ul.innerHTML = "";
            if (cachePendentes.length === 0) {
                ul.innerHTML = `<li class="text-center text-gray-500">Nenhuma hora pendente.</li>`
            } else {
                cachePendentes.forEach(item => {
                    const li = document.createElement("li");
                    li.className = "p-2 border rounded flex items-center justify-between gap-2";
                    li.innerHTML = `
                        <div>
                            <div class="font-medium">${item.funcionario}</div>
                            <div class="text-xs text-gray-600">${item.horas}h ‚Äî ${item.data} (${item.status})</div>
                        </div>
                        <div class="flex gap-2">
                            <button class="text-blue-600 underline text-sm btn-abrir" data-id="${item.id}">Abrir</button>
                        </div>
                    `;
                    ul.appendChild(li);
                });
            }
            ligarEventosAcao();
        } else {
            tbody.innerHTML = `<tr><td colspan="7" class="text-center p-3">Nenhum registro encontrado.</td></tr>`;
            document.getElementById("badgePendentes").classList.add("hidden");
            document.getElementById("listaPendentes").innerHTML = "";
        }
        filtrarTabela();
    }

    // Fun√ß√£o para calcular e atualizar o dashboard
    function atualizarDashboard(dadosHoras, dadosFuncionarios, dadosGastos) {
        let totalHorasAprovadas = 0;
        let totalCustoAprovado = 0;
        
        if (dadosHoras) {
            Object.values(dadosHoras).forEach(linha => {
                const horas = parseInt(linha.horas ?? 0, 10) || 0;
                const status = linha.status ?? "pendente";
                const valorpago = linha.valorpago || 0;
                
                if (status === "aprovado" || status === "pago") {
                    totalHorasAprovadas += horas;
                }
                if (status === "pago") {
                    totalCustoAprovado += valorpago;
                }
            });
        }

        const totalFuncionarios = dadosFuncionarios ? Object.keys(dadosFuncionarios).length : 0;
        
        let totalGastosExtras = 0;
        if (dadosGastos) {
            Object.values(dadosGastos).forEach(gasto => {
                totalGastosExtras += parseFloat(gasto.valor || 0);
            });
        }

        // Atualiza os elementos HTML
        document.getElementById("totalHoras").textContent = `${totalHorasAprovadas}h`;
        document.querySelector(".grid > div:nth-child(1) p").textContent = totalGastosExtras.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        document.querySelector(".grid > div:nth-child(2) p").textContent = totalHorasAprovadas > 0 ? (totalCustoAprovado / totalHorasAprovadas).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : "R$ 0,00";
        document.querySelector(".grid > div:nth-child(3) p").textContent = totalFuncionarios;
    }


    function ligarEventosAcao() {
        document.querySelectorAll(".btn-acao").forEach(btn => {
            btn.addEventListener("click", () => {
                const id = btn.getAttribute("data-id");
                abrirModalPorId(id);
            });
        });
        document.querySelectorAll(".btn-abrir").forEach(btn => {
            btn.addEventListener("click", () => {
                const id = btn.getAttribute("data-id");
                fecharPendentes();
                abrirModalPorId(id);
            });
        });
    }
    
    function abrirModalPorId(id) {
        const item = cacheLinhas.find(x => x.id === id);
        if (!item) return;

        registroAtualId = id;
        document.getElementById("modalFuncionario").textContent = item.funcionario;
        document.getElementById("modalData").textContent = item.data;
        document.getElementById("modalHoras").textContent = item.horas;
        document.getElementById("modalObs").textContent = item.obs;
        document.getElementById("modalValorPago").value = parseFloat(item.valorpago).toFixed(2);
        
        const modal = document.getElementById("modal");
        modal.classList.remove("hidden");
        modal.classList.add("flex");

        const btnA = document.getElementById("btnAprovar");
        const btnN = document.getElementById("btnNegar");
        const btnP = document.getElementById("btnPagar");

        btnA.onclick = () => atualizarStatus("aprovado");
        btnN.onclick = () => atualizarStatus("recusado");
        btnP.onclick = () => pagarHoraExtra();
    }

    function atualizarStatus(novoStatus) {
        if (!registroAtualId) return;
        const motivo = document.getElementById("modalMotivo").value.trim();
        const refItem = ref(db, "horas-extras/" + registroAtualId);
        const payload = motivo ? { status: novoStatus, motivoChefe: motivo } : { status: novoStatus };

        update(refItem, payload).then(() => {
            fecharModal();
        }).catch(err => {
            console.error("Falha ao atualizar status:", err);
            alert("Erro ao atualizar. Veja o console.");
        });
    }

    function pagarHoraExtra() {
        if (!registroAtualId) {
            alert("Nenhum registro selecionado para pagamento.");
            return;
        }

        const valorInput = document.getElementById("modalValorPago").value;
        const valorPago = parseFloat(valorInput);

        if (isNaN(valorPago) || valorPago < 0) {
            alert("Por favor, insira um valor v√°lido e positivo.");
            return;
        }

        const refItem = ref(db, "horas-extras/" + registroAtualId);
        
        const payload = {
            status: "pago", 
            valorpago: valorPago 
        };

        update(refItem, payload).then(() => {
            alert("Pagamento registrado com sucesso!");
            fecharModal();
        }).catch(err => {
            console.error("Falha ao registrar pagamento:", err);
            alert("Erro ao registrar pagamento. Veja o console.");
        });
    }
    
    function adicionarHoras(event) {
        event.preventDefault();
        const funcionario = document.getElementById("addFuncionario").value;
        const data = document.getElementById("addData").value;
        const horas = document.getElementById("addHoras").value;
        const obs = document.getElementById("addObs").value;
        
        const [ano, mes, dia] = data.split('-');
        const dataFormatada = `${dia}/${mes}/${ano}`;

        const novaHoraRef = push(ref(db, 'horas-extras'));
        set(novaHoraRef, {
            funcionario: funcionario,
            data: dataFormatada,
            horas: parseInt(horas),
            observacao: obs,
            status: "aprovado",
            valorpago: 0
        }).then(() => {
            alert("Horas adicionadas com sucesso!");
            fecharModalAdicionar();
        }).catch(error => {
            console.error("Erro ao adicionar horas: ", error);
            alert("Erro ao adicionar horas. Veja o console.");
        });
    }

    function popularDestinatarios() {
        const destinatarios = ["Chefe", "Kaio", "Edclenio", "Fabiano", "Hercules", "Iago", "Jeferson", "Junior"];
        
        recipientSelect.innerHTML = '';
        destinatarios.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            recipientSelect.appendChild(option);
        });
    }

    function carregarDados() {
        popularDestinatarios();
        
        // Escuta mudan√ßas no n√≥ de horas-extras
        onValue(ref(db, "horas-extras"), (snapshot) => {
            dadosHoras = snapshot.val();
            carregarTabelaHoras(dadosHoras);
            if (dadosFuncionarios && dadosGastos) {
                atualizarDashboard(dadosHoras, dadosFuncionarios, dadosGastos);
            }
        });

        // Escuta mudan√ßas no n√≥ de funcionarios
        onValue(ref(db, "funcionarios"), (snapshot) => {
            dadosFuncionarios = snapshot.val();
            if (dadosHoras && dadosGastos) {
                atualizarDashboard(dadosHoras, dadosFuncionarios, dadosGastos);
            }
        });

        // Escuta mudan√ßas no n√≥ de gastos
        onValue(ref(db, "gastos"), (snapshot) => {
            dadosGastos = snapshot.val();
            if (dadosHoras && dadosFuncionarios) {
                atualizarDashboard(dadosHoras, dadosFuncionarios, dadosGastos);
            }
        });

        checkAndRenderReminders();
    }
    
    document.getElementById("btnAbrirPendentes").addEventListener("click", () => abrirPendentes());
    document.getElementById("btnAdicionarHoras").addEventListener("click", () => abrirModalAdicionar());
    document.getElementById("formAdicionarHoras").addEventListener("submit", adicionarHoras);
    document.getElementById("btnExtraHours").addEventListener("click", () => {
        document.getElementById("filtroFuncionario").focus();
    });

    carregarDados();
</script>
</body>

</html>





